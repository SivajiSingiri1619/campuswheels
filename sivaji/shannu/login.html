<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log In</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Utility class to hide elements */
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <!-- Main container card -->
    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <div>
            <h1 class="text-3xl font-bold text-center text-gray-900">Log In to Your Account</h1>
            <p class="mt-2 text-center text-gray-600">Enter your phone number to receive a login code.</p>
        </div>

        <!-- Step 1: Phone Number Input Form -->
        <div id="loginForm">
            <div>
                <label for="phone-number" class="text-sm font-medium text-gray-700">Phone Number</label>
                <input id="phone-number" name="phone-number" type="tel" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="+1 123-456-7890">
            </div>
            <button id="send-otp-btn" class="w-full px-4 py-3 mt-6 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                Send OTP
            </button>
        </div>

        <!-- Step 2: OTP Verification Form (hidden by default) -->
        <div id="otpForm" class="hidden">
            <p class="text-center text-gray-600 mb-4">An OTP has been sent to your phone. Please enter it below.</p>
            <div>
                <label for="otp" class="text-sm font-medium text-gray-700">OTP</label>
                <input id="otp" name="otp" type="text" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="123456">
            </div>
            <button id="verify-otp-btn" class="w-full px-4 py-3 mt-6 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                Verify OTP & Log In
            </button>
        </div>

        <!-- This div is required by Firebase for the invisible reCAPTCHA -->
        <div id="recaptcha-container"></div>
        
        <!-- Status message to show errors or success messages to the user -->
        <p id="status-message" class="mt-4 text-center text-sm text-red-600"></p>
        
        <!-- Link to the sign-up page -->
        <p class="text-center text-sm text-gray-500 mt-4">
            Don't have an account? <a href="./signup.html" class="font-medium text-indigo-600 hover:text-indigo-500">Sign Up</a>
        </p>
    </div>

    <!-- JavaScript module for Firebase logic -->
    <script type="module">
        // Import necessary functions from Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ---
        // You can get this from your Firebase project settings.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ---------------------------------------------------------

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Get references to the HTML elements
        const loginForm = document.getElementById('loginForm');
        const otpForm = document.getElementById('otpForm');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const statusMessage = document.getElementById('status-message');

        // Set up the invisible reCAPTCHA verifier
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });

        // Pre-render the reCAPTCHA on page load to avoid delays and errors
        window.onload = () => {
            window.recaptchaVerifier.render().catch(error => {
                console.error("reCAPTCHA render error:", error);
                statusMessage.textContent = "Could not initialize verification. Please refresh the page.";
            });
        };

        // Add click event listener for the "Send OTP" button
        sendOtpBtn.addEventListener('click', async () => {
            const phoneNumber = document.getElementById('phone-number').value;
            statusMessage.textContent = ''; // Clear previous messages

            // Validate phone number format
            if (!phoneNumber || !phoneNumber.startsWith('+')) {
                statusMessage.textContent = 'Please enter a valid phone number with a country code (e.g., +1...).';
                return;
            }

            try {
                // *** REQUIREMENT MET HERE ***
                // Before sending an OTP, we check if a user document with this phone number
                // already exists in the 'users' collection in your Firestore database.
                const userDocRef = doc(db, "users", phoneNumber);
                const docSnap = await getDoc(userDocRef);

                // If the document does NOT exist, show an error and stop the login process.
                if (!docSnap.exists()) {
                    statusMessage.textContent = 'No account found with this phone number. Please sign up first.';
                    return; // Stop execution here
                }

                // If the document exists, we can proceed to send the OTP.
                const appVerifier = window.recaptchaVerifier;
                const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                
                // Store the confirmation result to use when verifying the OTP
                window.confirmationResult = confirmationResult;
                
                // *** REQUIREMENT MET HERE ***
                // Switch the UI from the phone input to the OTP input box.
                loginForm.classList.add('hidden');
                otpForm.classList.remove('hidden');
                statusMessage.textContent = `OTP sent to ${phoneNumber}`;
                statusMessage.className = 'mt-4 text-center text-sm text-green-600';

            } catch (error) {
                console.error("Error sending OTP:", error);
                statusMessage.textContent = 'Error sending OTP. Please try again.';
                // Reset reCAPTCHA in case of an error
                grecaptcha.reset(window.recaptchaWidgetId);
            }
        });

        // Add click event listener for the "Verify OTP" button
        verifyOtpBtn.addEventListener('click', async () => {
            const otp = document.getElementById('otp').value;
            if (!otp) {
                statusMessage.textContent = 'Please enter the OTP.';
                return;
            }

            try {
                // Use the stored confirmationResult to confirm the OTP
                await window.confirmationResult.confirm(otp);
                
                // *** REQUIREMENT MET HERE ***
                // If the OTP is correct, the user is logged in.
                // Now, we redirect them to the home page.
                window.location.href = './home.html';

            } catch (error) {
                // This usually means the OTP was incorrect
                console.error("Error verifying OTP:", error);
                statusMessage.textContent = 'Invalid OTP. Please try again.';
            }
        });
    </script>
</body>
</html>
